---
marp: true
---

## 個々のアプリのリポジトリでTerraformを管理している話

###### kagawa shoichi (@kanga333)
###### 2019/10/2
###### Terraform meetup tokyo#2 LT

---
<!-- *template: invert -->

## 自己紹介.tfvars

```
twitter = "@kanga333"
company = "Speee,Inc."
job     = "Infra Engineer"
team    = "UZOU(AdTech)"
```

- 好きなTerraformの機能はfor_each
- 今の会社/チームに参加して半年くらい

---

## はじめに

- UZOUでは各アプリケーションリポジトリ毎に`terraform`ディレクトリを切ってTerraform設定を分散して管理しています
  - 例えばアドサーバ/クローラー/管理画面/バッチなど機能別で別れています
- 一方で自分の今までの経験で多かった構成はインフラ/SREチームがオーナーの統一的なTerraformリポジトリという構成でした
- 後者に慣れ親しんでいたので前者の構成に最初は抵抗があったんですが実際やってみると良さがわかったので簡単にご紹介します

---

## 普通？のTerraform管理方法
- 普通の基準は主観です
- `hoge-terraform`みたいな共通リポジトリに設定を集約
- SRE/インフラチームに類する人たちがオーナ
- moduleを作ってある程度Dryにする
- アプリケーション軸か使用するサービス軸でmain.tfは分ける

---

## UZOUでのTerrform管理方法

- 各アプリケーション毎にTerraform設定を分散して管理
- 例えばアドサーバのコードのリポジトリと一緒に以下のtfリソースを管理
  - ELB/AutoScaling/DatadogMonitor/etc...
    - アプリケーションを実行するために必要なインフラリソースほぼ全て
- main.tfは各アプリ毎で１つ
  - ワークスペースのような形で各環境間でtfvarsだけ変えている
- リポジトリをまたいだ共通モジュールは今の所ない
  - あんまりDryにはしていない
- 歴史的にフルスタックエンジニアxN人のチームで運用されていたので自然とこうなった

---

## 良かったこと
- アプリケーションが使用するインフラリソースがわかりやすい
- Terraform変更の影響範囲が明確
- Terraformのアップグレードを必要に応じてできるし簡単
- Plan早い
- アプリの変更とインフラの変更を一緒にレビューできる

---

## 良くないこと
- コピペベースなので同じような修正が何度も必要
  - 何度も`terraform 0.12upgrade`が必要
- 書き方にムラがでやすい
- CI/CDが大変
  - 現状JenkinsジョブをポチってPlan/Applyする感じなのでいい感じにしたい...
- インフラ構成全体の把握に時間がかかる

---

## 工夫してる点
- AWSのタグを使って管理しているリポジトリを明確にする
  - これどこで管理してるんだっけ？を防止
- 全体像を把握する際はAWS側の画面やサービスを駆使する
　- TrustedAdvisor/AWSConfig/GuardDuty/CostExplorer

---

## 今の構成でも上手くいっている理由
- チーム状況とフィットしている
  - みんなTerraform設定を書く
  - インフラチーム的なものは無い
    - そもそもチームの人数は5人
  - システム規模はそれなりに大きいけどもめちゃくちゃデカイ訳ではない
    - 大体インスタンス60 ~ 70台くらい

---

## とはいえ今後このままで行くのか？
- インフラ的なメンバー増えたら統一リポジトリに寄せるのはあり得る
  - その場合はstate mv祭りだなぁ...
- マイクロサービス的に各サービス毎のチームができたら今の構成でも良い気もする
- 必要になったら考える

---

## 月並みな結論
- 個々のチーム状況にあったリポジトリ設計が大事
  - コンウェイまじコンウェイ
- チーム状況が変われば抵抗のあった構成でも案外フィットするケースもある
- 将来チーム状況が変化した際にどう対応できるか考えておく
